---
- name: SV-48040r1_rule ACLs for system files and directories must conform to minimum requirements
  block:
    - name: Create directory structure 
      win_file:
        path: '{{ item }}'
        state: directory
      with_items:
        - '{{ root_folder }}'
        - '{{ windows_folder }}'
        - '{{ programs_folder }}'

    - name: Enable ACE inheritance
      win_acl_inheritance:
        path: '{{ item }}'
        state: absent
      with_items:
        - '{{ root_folder }}'
        - '{{ windows_folder }}'
        - '{{ programs_folder }}'

    - name: ACL for '{{ root_folder }}'
      win_acl:
        path: '{{ root_folder }}'
        user: '{{ item.user }}'
        rights: '{{ item.rights }}'
        type: '{{ item.type }}'
        state: present 
        inherit: '{{ item.inherit }}' 
        propagation: '{{ item.propagation }}'
      with_items:
        - user: '{{ builtin_administrators }}'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'None'
        - user: 'NT AUTHORITY\SYSTEM'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'None'
        - user: '{{ builtin_users }}'
          rights: 'Read, ReadAndExecute, ListDirectory'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'None'
        - user: '{{ nt_authusers }}'
          rights: 'AppendData'
          type: 'allow'
          inherit: 'None' 
          propagation: 'None'
        - user: '{{ nt_authusers }}'
          rights: 'Modify'
          type: 'allow'
          inherit: ContainerInherit,ObjectInherit
          propagation: 'InheritOnly'

    - name: ACL for '{{ windows_folder }}'
      win_acl:
        path: '{{ windows_folder }}'
        user: '{{ item.user }}'
        rights: '{{ item.rights }}'
        type: '{{ item.type }}'
        state: present 
        inherit: '{{ item.inherit }}' 
        propagation: '{{ item.propagation }}'
      with_items:
        - user: 'NT SERVICE\TrustedInstaller'
          rights: 'Full'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: 'NT SERVICE\TrustedInstaller'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit'
          propagation: 'InheritOnly'
        - user: 'NT AUTHORITY\SYSTEM'
          rights: 'Modify'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: 'NT AUTHORITY\SYSTEM'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'InheritOnly'
        - user: '{{ builtin_administrators }}'
          rights: 'Modify'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: '{{ builtin_administrators }}'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'InheritOnly'
        - user: '{{ builtin_users }}'
          rights: 'ReadData, ExecuteFile'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: '{{ builtin_users }}'
          rights: 'Read, ReadAndExecute, ListDirectory'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'InheritOnly'
        - user: 'CREATOR OWNER'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'InheritOnly'

    - name: ACL for '{{ programs_folder }}'
      win_acl:
        path: '{{ programs_folder }}'
        user: '{{ item.user }}'
        rights: '{{ item.rights }}'
        type: '{{ item.type }}'
        state: present 
        inherit: '{{ item.inherit }}' 
        propagation: '{{ item.propagation }}'
      with_items:
        - user: 'NT SERVICE\TrustedInstaller'
          rights: 'Full'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: 'NT AUTHORITY\SYSTEM'
          rights: 'Full'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: '{{ builtin_administrators }}'
          rights: 'Full'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: '{{ all }}'
          rights: 'Read'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: '{{ all }}'
          rights: 'Read, ReadAndExecute, ListDirectory'
          type: 'allow'
          inherit: 'None'
          propagation: 'None'
        - user: 'CREATOR OWNER'
          rights: 'Full'
          type: 'allow'
          inherit: 'ContainerInherit,ObjectInherit'
          propagation: 'InheritOnly'
  tags:
   - disa
   - stig

